---
output: pdf_document
---

```{r}
source('RECURSOS-INVESTIGACION/R/get-dat-basic-normalizada.R')
source('RECURSOS-INVESTIGACION/R/pef-r2-ids-eeff-forecast.R')
source('RECURSOS-INVESTIGACION/R/pef-list-summary-resumen.R')
source('RECURSOS-INVESTIGACION/R/pef-get-dats-for-forescat.R')
source('RECURSOS-INVESTIGACION/R/pef-get-ids-for-models.R')
source("RECURSOS-INVESTIGACION/R/pef-get-camel-test.R")
source("RECURSOS-INVESTIGACION/R/render-table-basic.R")

require(kableExtra)
require(patchwork)
require(ggplot2)
require(scales)
require(dplyr)
require(fpp2)

if (!('listResultPEF' %in% ls())) {
    
    datTotalSistema <- getDatEEFFNormalizada(by = 'TOTAL_SISTEMA')
    
    ids <- getVariablesForModelsForecast()
    
    listResultPEF <- getListFittedAndSimulateModels(datTotalSistema,ids)
    listResumeModels <- getListResumeSummaryModels(listResultPEF)
    listDatsForTestCamels <- getDatsForTestCamels(listResultPEF,datTotalSistema,12,TRUE)
    
    
    originalCamelTest <- getCamelTestForecast(listDatsForTestCamels$datCuentas)
    nnCamelTest <- getCamelTestForecast(listDatsForTestCamels$nnDataForecastCuentas)
    mcoCamelTest <- getCamelTestForecast(listDatsForTestCamels$mcoDataForecastCuentas)
    arimaCamelTest <- getCamelTestForecast(listDatsForTestCamels$arimaDataForecastCuentas)
    
    camelTestModels <- bind_rows(originalCamelTest,
                                 nnCamelTest,
                                 mcoCamelTest,
                                 arimaCamelTest)
    
    id <- 'EERR_S2_RESULTADO_NETO_DE_LA_GESTION'
    
    trendCamelRNN <- readRDS(file ='FUENTES-DE-DATOS/DATA/trendCamelRNN.rds')
    sdCamelRNN <- readRDS(file ='FUENTES-DE-DATOS/DATA/sdCamelRNN.rds')
}

```

## Presiciones de los pronosticos de estados financieros

Los pronósticos realizados en el presente capítulo estarán sujetos a las especificaciones dadas a continuación.

### Series de tiempo

Los datos ha ser modelados están definidos por series de tiempo (cada serie de tiempo representa una cuenta de los estados financieros) de `r nrow(datTotalSistema)` observaciones cada una, las cuales agrupan a todas las entidades del sistema financiero de Bolivia, presentadas en el capitulo anterior.

Así también los datos se dividen en dos grupos:

- Datos de entrenamiento.
- Datos para realizar pruebas.

Donde los datos de entrenamiento serán utilizados para entrenar los modelos y los datos de pruebas para contrastar el ajuste de los pronósticos de los modelos respecto a la misma.

```{r, fig.height = 10, fig.width = 20, fig.cap='Agrupamiento de los datos de las series de tiempo.'}
autoplot(listResultPEF[[id]]$tsDatTrain,series = 'Datos de entrenamiento') +
    autolayer(listResultPEF[[id]]$tsDatTest,series = 'Datos para realizar pruebas') +
    ylab('RESULTADO NETO DE LA GESTION') +
    xlab('TIEMPO') +
    guides(color=guide_legend(ncol=2, title="")) +
    theme(legend.position="bottom",
          legend.text = element_text(size=24),
          legend.key.size = unit(2, 'cm'),
          axis.title.x=element_text(size=24), 
          axis.title.y = element_text(size=30),
          axis.text.y=element_text(size=24),
          axis.text.x = element_text(size=24))
    
```

### Modelos 

Los modelo empleados para las proyecciones son los siguientes:

- Modelo clásico de series de tiempo
- ARIMA
- Redes neuronales artificiales (RNA)

#### Arquitectura de redes neuronales

<!-- https://github.com/cran/forecast/blob/master/R/nnetar.R -->

La arquitectura de una rede neuronal hace referencia al numero de capas, neuronas y funciones de activación que se aplicaran, estas mismas pueden ser asignadas de forma arbitraria donde el uso de muchas capas y neuronas causaran un sobre ajuste del modelo, y usar muy pocas hará que el modelo no pueda generalizar la información contenida en las series de tiempo.

Las redes neuronales que se emplearan en la presente investigación estarán sujetos a las siguientes lineamientos que determinan su arquitectura:

- Las series de tiempo son consideradas no estacionales.
- El numero de neuronas de entrada esta definido por el criterio de información de Akaike.
- El numero de capas ocultas serán igual a 1, con el mismo numero de neuronas que la capa de entrada.
- La función de activación de aplicar sera la función sigmoide.


#### Arquitectura de MCO

<!-- https://github.com/cran/forecast/blob/master/R/lm.R -->

$$ \text{Serie De Tiempo} = \text{ Tendencia + Estacionalidad} $$
Es decir:

$$ Y_{t+1} = \beta_{0} + \beta_{1}{T_{t+1}} + \beta_{2}{S_{1}} + \beta_{3}{S_{2}} + \beta_{4}{S_{3}} + \beta_{5}{S_{4}} + \beta_{6}{S_{5}} + \beta_{7}{S_{6}} + \beta_{8}{S_{7}} + \beta_{9}{S_{8}} + \beta_{10}{S_{9}} + \beta_{11}{S_{10}} + \beta_{12}{S_{11}} + \beta_{13}{S_{12}}  $$

Donde:

- $Y_{t+1} =$ Representa el precio futuro.
- $T =$ Representa el tiempo.
- $S_{i} =$ Representa la estacionalidad de serie dividiéndola en 12 por los meses contenidos en un año.
- $\beta_{i} =$ Representa la tasa de cambio, es decir, el efecto de la variable sobre el precio futuro.

En consecuencia el metodo a usar para ajustar los pesos en $\beta_{i}$ sera el de minimos cuadrados ordinarios (MCO).


#### Arquitectura ARIMA

<!-- https://github.com/cran/forecast/blob/878f06ca38ae78337c242c034bc814eb38df9be9/R/newarima2.R -->

Los modelos ARIMA (AutoRegressive Integrated Moving Average) es el resultado de la combinación de dos modelos que son los modelos auto regresivos y modelos de media móvil.

Los modelos auto regresivos están definidos por:

$$y_{t} = c + \phi_{1}y_{t-1} + \phi_{2}y_{t-2} + \dots + \phi_{p}y_{t-p} + \varepsilon_{t}$$

Y los modelos de promedios móviles están definidos por:

$$y_{t} = c + \varepsilon_t + \theta_{1}\varepsilon_{t-1} + \theta_{2}\varepsilon_{t-2} + \dots + \theta_{q}\varepsilon_{t-q}$$

Donde la integración de ambos modelos dan lugar al modelo ARIMA, que se puede definir como:

$$ y'_{t} = c + \phi_{1}y'_{t-1} + \cdots + \phi_{p}y'_{t-p} + \theta_{1}\varepsilon_{t-1} + \cdots + \theta_{q}\varepsilon_{t-q} + \varepsilon_{t} $$

### Evaluación de modelos

Para poder evaluar la eficacia de los modelos se hara uso del ajuste de las predicciones que haga dicho modelo.

$$ R2 = \left ( \frac{ \sum{[(x_{i}-\bar{x})-(y_{i}-\bar{y})]} } { \sqrt{ \sum{(x_{i}-\bar{x})^{2}} * \sum{(y_{i}-\bar{y})^{2}} } }  \right )^{2} $$

#### R2 sobre datos de entrenamiento

Representa el ajuste entre los datos observados y los datos ajustados por el modelo.

#### R2 sobre datos de prueba

Representa el ajuste entre los datos observados y los datos proyectados por el modelo.

#### Aplicación de metodologia CAMEL sobre datos proyectados

Como en ultimo método de evaluación se utilizara la metodología CAMEL sobre datos proyectados por los modelos y los datos efectivamente observados que son los datos de prueba, para asi poder cuestionar si estas proyecciones siguen la misma tendencia que los datos observados.


### Variables comprendidas

La variables comprendidas para los pronósticos son las mismas definidas en el capitulo anterior, incluyendo los siguientes:

- Activo
- Pasivo
- Patrimonio
- Ingresos

