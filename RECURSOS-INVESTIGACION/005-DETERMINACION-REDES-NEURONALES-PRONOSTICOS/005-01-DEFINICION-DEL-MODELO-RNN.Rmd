
```{r}
source('RECURSOS-INVESTIGACION/R/get-dat-basic-normalizada.R')
source('RECURSOS-INVESTIGACION/R/pef-r2-ids-eeff-forecast.R')
source('RECURSOS-INVESTIGACION/R/pef-list-summary-resumen.R')
source('RECURSOS-INVESTIGACION/R/pef-get-dats-for-forescat.R')
source('RECURSOS-INVESTIGACION/R/pef-get-ids-for-models.R')
source("RECURSOS-INVESTIGACION/R/pef-get-camel-test.R")
source("RECURSOS-INVESTIGACION/R/render-table-basic.R")

require(kableExtra)
require(patchwork)
require(ggplot2)
require(scales)
require(dplyr)
require(fpp2)

if (!('listResultPEF' %in% ls())) {
    
    datTotalSistema <- getDatEEFFNormalizada(by = 'TOTAL_SISTEMA')
    
    ids <- getVariablesForModelsForecast()
    
    listResultPEF <- getListFittedAndSimulateModels(datTotalSistema,ids)
    listResumeModels <- getListResumeSummaryModels(listResultPEF)
    listDatsForTestCamels <- getDatsForTestCamels(listResultPEF,datTotalSistema,12,TRUE)
    
    
    originalCamelTest <- getCamelTestForecast(listDatsForTestCamels$datCuentas)
    nnCamelTest <- getCamelTestForecast(listDatsForTestCamels$nnDataForecastCuentas)
    mcoCamelTest <- getCamelTestForecast(listDatsForTestCamels$mcoDataForecastCuentas)
    arimaCamelTest <- getCamelTestForecast(listDatsForTestCamels$arimaDataForecastCuentas)
    
    camelTestModels <- bind_rows(originalCamelTest,
                                 nnCamelTest,
                                 mcoCamelTest,
                                 arimaCamelTest)
    
    id <- 'EERR_S2_RESULTADO_NETO_DE_LA_GESTION'
    
    trendCamelRNN <- readRDS(file ='FUENTES-DE-DATOS/DATA/trendCamelRNN.rds')
    sdCamelRNN <- readRDS(file ='FUENTES-DE-DATOS/DATA/sdCamelRNN.rds')
}

```

## Precisiones de los pronósticos de estados financieros

Los pronósticos realizados en el presente capítulo estarán sujetos a las especificaciones dadas a continuación.

### Series de tiempo

Los datos a ser modelados están definidos como series de tiempo (cada serie de tiempo representa una cuenta de los estados financieros) de `r nrow(datTotalSistema)` observaciones cada una, las cuales agrupan a todas las entidades del sistema financiero de Bolivia, presentadas en el capítulo anterior.

Así mismo los datos se dividen en dos grupos:

- Datos de entrenamiento.
- Datos para realizar pruebas.

Donde los datos de entrenamiento serán utilizados para adaptar los modelos y los datos de pruebas buscarán contrastar el ajuste de los pronósticos de los modelos respecto a la misma.

```{r, fig.height = 10, fig.width = 20, fig.cap='Agrupamiento de los datos de las series de tiempo.'}
autoplot(listResultPEF[[id]]$tsDatTrain,series = 'Datos de entrenamiento') +
    autolayer(listResultPEF[[id]]$tsDatTest,series = 'Datos para realizar pruebas') +
    ylab('RESULTADO NETO DE LA GESTION') +
    xlab('TIEMPO') +
    guides(color=guide_legend(ncol=2, title="")) +
    theme(legend.position="bottom",
          legend.text = element_text(size=24),
          legend.key.size = unit(2, 'cm'),
          axis.title.x=element_text(size=24), 
          axis.title.y = element_text(size=30),
          axis.text.y=element_text(size=24),
          axis.text.x = element_text(size=24))
    
```

### Modelos 

Los modelos empleados para realizar las proyecciones son los siguientes:

- Redes neuronales artificiales (NN)
- Modelo clásico de series de tiempo (MCO)
- ARIMA

Los cuales estarán sujetos a las arquitecturas o especificaciones que se mencionan a continuación.

#### Redes neuronales (NN)

<!-- https://github.com/cran/forecast/blob/master/R/nnetar.R -->

La arquitectura de una rede neuronal hace referencia al número de capas, neuronas y funciones de activación que se aplicaran, estas mismas pueden ser asignadas de forma arbitraria donde el uso de muchas capas y neuronas causaran un sobre ajuste del modelo, y usar muy pocas hará que el modelo no pueda generalizar la información contenida en las series de tiempo, en consecuencia las redes neuronales que se emplearan en la presente investigación estarán sujetos a las siguientes lineamientos que determinan su arquitectura:

- El número de neuronas de entrada está definido por el criterio de información de Akaike (AIC).
- El número de capas ocultas serán igual a 1, con el mismo número de neuronas que la capa de entrada.
- La función de activación de aplicar será la función sigmoide.
- El algoritmo esta desarrollado en el lenguaje de programación R.

Las especificaciones del algoritmo utilizado corresponden al paquete "forecast" del repositorio publico CRAN [@R-forecast].


#### Modelo clásico de series de tiempo (MCO)

<!-- https://github.com/cran/forecast/blob/master/R/lm.R -->

El modelo clásico de series de tiempo define a la misma como la suma de dos elementos:

$$ \text{Serie De Tiempo} = \text{ Tendencia + Estacionalidad} $$

Entendiendo la tendencia como la tasa de cambio de la serie de tiempo respecto al tiempo y las estacionalidades como tasas de cambio correspondientes a variables dicótomas, es decir, solo pueden asumir valores de 0 o 1 cuando la observación se encuentre en la estacionalidad dada, así mismo el modelo presentado asume una estacionalidad de 12 periodos que en consecuencia la ecuación antes mencionada toma la siguiente forma:

$$Y_{t} = \beta_{0} + \beta_{1}{T_{t}} + \sum_{\substack{i=2\\j=2}}^{\substack{i=n\\ j=m}}{\beta_{i}{S_{j}}} $$

\newpage
Donde:

- $Y_{t} =$ Representa el valor de la serie en el momento t.
- $T =$ Representa el tiempo.
- $S_{i} =$ Representa la estacionalidad de serie dividiéndola en 12 por los meses contenidos en un año.
- $\beta_{i} =$ Representa la tasa de cambio, es decir, el efecto de la variable sobre la serie de tiempo.

Así mismo, el método a usar para ajustar los pesos en $\beta_{i}$ sera el de mínimos cuadrados ordinarios (MCO).


#### Modelo ARIMA

<!-- https://github.com/cran/forecast/blob/878f06ca38ae78337c242c034bc814eb38df9be9/R/newarima2.R -->

Los modelos ARIMA (AutoRegressive Integrated Moving Average) es el resultado de la combinación de dos modelos que son los modelos auto regresivos y modelos de media móvil.

Los modelos auto regresivos están definidos por:

$$y_{t} = c + \phi_{1}y_{t-1} + \phi_{2}y_{t-2} + \dots + \phi_{p}y_{t-p} + \varepsilon_{t}$$

Y los modelos de promedios móviles están definidos por:

$$y_{t} = c + \varepsilon_t + \theta_{1}\varepsilon_{t-1} + \theta_{2}\varepsilon_{t-2} + \dots + \theta_{q}\varepsilon_{t-q}$$

Donde la integración de ambos modelos da lugar al modelo ARIMA, que se puede definir como:

$$ y_{t} = c + \phi_{1}y_{t-1} + \cdots + \phi_{p}y_{t-p} + \theta_{1}\varepsilon_{t-1} + \cdots + \theta_{q}\varepsilon_{t-q} + \varepsilon_{t} $$

Donde las especificaciones del algoritmo utilizado para el presente modelo corresponden al paquete "forecast" del repositorio publico CRAN [@R-forecast].


### Evaluación de modelos

Una vez finalizado el entrenamiento de los modelos para las diferentes series de tiempo se evaluará la validez o consistencia de los mismos siguiendo dos criterios:

- Ajuste del modelo.
- Capacidad de generalización del modelo.

Donde se realizará una evaluación CAMEL sobre los datos proyectados para visualizar la capacidad de generalización de los modelos, es decir, si los datos proyectados siguen la misma tendencia que los datos efectivamente observados.

Así también, el ajuste de los modelos está determinado por el estadístico R2 que se define como:

$$ R2 = \left ( \frac{ \sum{[(x_{i}-\bar{x})-(y_{i}-\bar{y})]} } { \sqrt{ \sum{(x_{i}-\bar{x})^{2}} * \sum{(y_{i}-\bar{y})^{2}} } }  \right )^{2} $$

Donde el presente estadístico puede ser aplicado antes y después del entrenamiento:

#### R2 sobre datos de entrenamiento

Representa el ajuste existente entre los datos observados en el entrenamiento respecto a los datos pronosticados para los mismos intervalos de tiempo.

#### R2 sobre datos de prueba

Representa el ajuste entre los datos observados para realizar pruebas respecto los datos proyectados por el modelo para los mismos intervalos de tiempo.


### Variables comprendidas

Las variables comprendidas que corresponden a las cuentas representadas en forma de series de tiempo para los pronósticos son las mismas definidas en el capítulo anterior:

- Activo
- Disponibilidades
- Inversiones temporarias
- Cartera vigente, vencida y en ejecución
- Cartera reprogramada vigente, vencida y en ejecución
- Cartera reestructurada vigente, vencida y en ejecución
- Previsión de incobrabilidad de cartera
- Bienes realizables
- Cuentas contingentes deudoras
- Pasivo
- Patrimonio
- Ingresos
- Gastos de administración
- Impuestos
- Resultado operativo bruto
- Resultado neto de la gestión
- Coeficiente de adecuación patrimonial

Debiendo aclarar que el coeficiente de adecuación patrimonial no es una cuenta del manual de cuentas de ASFI, pero se realiza sus pronósticos al ser necesario para la evaluación de los modelos por la metodología CAMEL.

