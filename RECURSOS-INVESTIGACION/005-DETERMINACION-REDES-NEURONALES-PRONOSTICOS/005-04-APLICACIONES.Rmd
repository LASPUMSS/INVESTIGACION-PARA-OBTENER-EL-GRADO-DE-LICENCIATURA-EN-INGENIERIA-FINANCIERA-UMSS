---
output: pdf_document
---

```{r}
source('RECURSOS-INVESTIGACION/R/get-dat-basic-normalizada.R')
source('RECURSOS-INVESTIGACION/R/pef-r2-ids-eeff-forecast.R')
source('RECURSOS-INVESTIGACION/R/pef-list-summary-resumen.R')
source('RECURSOS-INVESTIGACION/R/pef-get-dats-for-forescat.R')
source('RECURSOS-INVESTIGACION/R/pef-get-ids-for-models.R')
source("RECURSOS-INVESTIGACION/R/pef-get-camel-test.R")
source("RECURSOS-INVESTIGACION/R/render-table-basic.R")

require(kableExtra)
require(patchwork)
require(ggplot2)
require(dplyr)
require(fpp2)

if (!('listResultPEF' %in% ls())) {
    
    datTotalSistema <- getDatEEFFNormalizada(by = 'TOTAL_SISTEMA')
    
    ids <- getVariablesForModelsForecast()
    
    listResultPEF <- getListFittedAndSimulateModels(datTotalSistema,ids)
    listResumeModels <- getListResumeSummaryModels(listResultPEF)
    listDatsForTestCamels <- getDatsForTestCamels(listResultPEF,datTotalSistema,12,TRUE)
    
    
    originalCamelTest <- getCamelTestForecast(listDatsForTestCamels$datCuentas)
    nnCamelTest <- getCamelTestForecast(listDatsForTestCamels$nnDataForecastCuentas)
    mcoCamelTest <- getCamelTestForecast(listDatsForTestCamels$mcoDataForecastCuentas)
    arimaCamelTest <- getCamelTestForecast(listDatsForTestCamels$arimaDataForecastCuentas)
    
    camelTestModels <- bind_rows(originalCamelTest,
                                 nnCamelTest,
                                 mcoCamelTest,
                                 arimaCamelTest)
    
    id <- 'EERR_S2_RESULTADO_NETO_DE_LA_GESTION'
    
    trendCamelRNN <- readRDS(file ='FUENTES-DE-DATOS/DATA/trendCamelRNN.rds')
    sdCamelRNN <- readRDS(file ='FUENTES-DE-DATOS/DATA/sdCamelRNN.rds')
}

```

## Aplicación de metodologia CAMEL sobre datos proyectados

Para empezar los pesos en las neuronas que dotan de la capacidad de aprendizaje a la red inicialmente toman valores aleatorios

Como tercer método de evaluación de los modelos se realiza una valuación CAMEL sobre los datos proyectados dando lugar los siguientes resultados:

```{r}

renderTableBasic(camelTestModels, 
                 captionTable = 'Aplicacion',
                 fontSize = 8) %>% 
    pack_rows(index = c('DATOS ORIGINALES',
                        'REDES NEURONALES',
                        'MCO',
                        'ARIMA'))
```

Hacer notar que debido a la naturaleza de la arquitectura de las redes neuronales cuando estos se re-entrenan no darán los mismos pronósticos, ya que el primer paso de entrenamiento los pesos asignados en las diferentes neuronas son aleatorios, dada esta situación se realizo `r length(trendCamelRNN)` con sus respectivos pronósticos y sobre los cuales se aplico la metodología CAMEL dando lugar a las siguientes tendencias:

```{r, fig.height = 10, fig.width = 20, fig.cap='Historgrama de diferentes redes neuronales entrenadas.'}

p1 <- 
    data.frame(trendCamelRNN=trendCamelRNN) %>% 
    ggplot(aes(x=trendCamelRNN)) + 
    geom_histogram()

p2 <- 
    data.frame(sdCamelRNN=sdCamelRNN) %>% 
    ggplot(aes(x=sdCamelRNN)) + 
    geom_histogram()

p1+p2
```


Donde se observa que la tendencia promedio en la calificación CAMEL de los pronósticos realizados por las distintas redes neuronales es de `r mean(trendCamelRNN)`, `r mean(sdCamelRNN)` lo que en consiguiente nos permite afirmar que las redes neuronales pueden encontrar patrones no sujetos al análisis subjetivo en las series de tiempo lo que da lugar a mejores pronósticos de los mismos.

