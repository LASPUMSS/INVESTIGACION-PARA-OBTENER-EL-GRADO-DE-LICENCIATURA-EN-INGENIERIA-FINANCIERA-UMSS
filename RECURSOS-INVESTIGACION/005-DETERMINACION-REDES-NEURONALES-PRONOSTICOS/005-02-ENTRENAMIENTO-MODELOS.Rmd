---
output: pdf_document
---

```{r}
source('RECURSOS-INVESTIGACION/R/get-dat-basic-normalizada.R')
source('RECURSOS-INVESTIGACION/R/pef-r2-ids-eeff-forecast.R')
source('RECURSOS-INVESTIGACION/R/pef-list-summary-resumen.R')
source('RECURSOS-INVESTIGACION/R/pef-get-dats-for-forescat.R')
source('RECURSOS-INVESTIGACION/R/pef-get-ids-for-models.R')
source("RECURSOS-INVESTIGACION/R/pef-get-camel-test.R")
source("RECURSOS-INVESTIGACION/R/render-table-basic.R")

require(kableExtra)
require(patchwork)
require(ggplot2)
require(dplyr)
require(fpp2)

if (!('listResultPEF' %in% ls())) {
    
    datTotalSistema <- getDatEEFFNormalizada(by = 'TOTAL_SISTEMA')
    
    ids <- getVariablesForModelsForecast()
    
    listResultPEF <- getListFittedAndSimulateModels(datTotalSistema,ids)
    listResumeModels <- getListResumeSummaryModels(listResultPEF)
    listDatsForTestCamels <- getDatsForTestCamels(listResultPEF,datTotalSistema,12,TRUE)
    
    
    originalCamelTest <- getCamelTestForecast(listDatsForTestCamels$datCuentas)
    nnCamelTest <- getCamelTestForecast(listDatsForTestCamels$nnDataForecastCuentas)
    mcoCamelTest <- getCamelTestForecast(listDatsForTestCamels$mcoDataForecastCuentas)
    arimaCamelTest <- getCamelTestForecast(listDatsForTestCamels$arimaDataForecastCuentas)
    
    camelTestModels <- bind_rows(originalCamelTest,
                                 nnCamelTest,
                                 mcoCamelTest,
                                 arimaCamelTest)
    
    id <- 'EERR_S2_RESULTADO_NETO_DE_LA_GESTION'
    
    trendCamelRNN <- readRDS(file ='FUENTES-DE-DATOS/DATA/trendCamelRNN.rds')
    sdCamelRNN <- readRDS(file ='FUENTES-DE-DATOS/DATA/sdCamelRNN.rds')
}

```

## Entrenamiento de modelos, proyeciones y simulaciones

### MCO

```{r, echo=TRUE}
coef(listResultPEF[[id]]$mcoModel)
```



### ARIMA

```{r, echo=TRUE}
coef(listResultPEF[[id]]$arimaModel)
```


### NN

```{r}
library(devtools)
source_url('https://gist.githubusercontent.com/fawda123/7471137/raw/466c1474d0a505ff044412703516c34f1a4684a5/nnet_plot_update.r')

wts.in<-listResultPEF[[id]]$nnModel$model[[1]]$wts
struct<-listResultPEF[[id]]$nnModel$model[[1]]$n
plot.nnet(wts.in,struct=struct)
```


```{r, echo=TRUE}
wts.in
```


### Eficiencia de los modelos en el entrenamiento

```{r}
renderTableBasic( listResumeModels$r2ModelsResum %>% filter(CUENTAS==id), 
                  captionTable = 'Ajuste R2 de modelos para resultado neto de la gestion')
```

Posteriormente los modelos presentados en la anterior secciÃ³n son entrenados sujetas a sus respectivas  especificaciones.

### Eficiencia de los modelos en los pronosticos

```{r}
renderTableBasic( listResumeModels$r2ForecastResum %>% filter(CUENTAS==id),
                  captionTable = 'Ajuste R2 de proyecciones de modelos para resultado neto de la gestion')
```

### Simulacion de proyeciones

Sobre los mismos modelos se proyecciones simuladas sujetas a desviaciones de error que el modelo presento en su entrenamiento.

Posteriormente calculamos el ajuste de los datos proyectados simulados respecto a los datos observados.

```{r}
z <- data.frame(r2Model=listResultPEF[[id]]$nnModelSimulate$r2Model)
p1 <- z %>% ggplot(aes(x=r2Model)) + geom_histogram() + ggtitle('NN')

z <- data.frame(r2Model=listResultPEF[[id]]$mcoModelSimulate$r2Model)
p2 <- z %>% ggplot(aes(x=r2Model)) + geom_histogram() + ggtitle('MCO')

z <- data.frame(r2Model=listResultPEF[[id]]$arimaModelSimulate$r2Model)
p3 <- z %>% ggplot(aes(x=r2Model)) + geom_histogram() + ggtitle('ARIMA')

p1/p2/p3
```



